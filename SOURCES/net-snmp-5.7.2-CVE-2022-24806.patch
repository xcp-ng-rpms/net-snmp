From df7533052991f49704e5550c4cd2d965c4927813 Mon Sep 17 00:00:00 2001
From: Bill Fenner <fenner@gmail.com>
Date: Tue, 24 Aug 2021 07:55:00 -0700
Subject: [PATCH] CHANGES: snmpd: recover SET status from delegated request
Content-Type: text/plain; charset = "utf-8"
Content-Transfert-Encoding: 8bit

Reported by: Yu Zhang of VARAS@IIE, Nanyu Zhong of VARAS@IIE
Fixes by: Arista Networks

When a SET request includes a mix of delegated and
non-delegated requests (e.g., objects handled by master
agent and agentx sub-agent), the status can get lost while
waiting for the reply from the sub-agent.  Recover the status
into the session from the requests even if it has already
been processed.
---
 agent/snmp_agent.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Backport notes:
 upstream commit 9a0cd7c00947d5e1c6ceb54558d454f87c3b8341
 Backported-By: Thierry Escande <thierry.escande@vates.tech>

diff --git a/agent/snmp_agent.c b/agent/snmp_agent.c
index b84060d..8579bf1 100644
--- a/agent/snmp_agent.c
+++ b/agent/snmp_agent.c
@@ -2643,7 +2643,7 @@ netsnmp_check_requests_status(netsnmp_agent_session *asp,
         if (requests->status != SNMP_ERR_NOERROR &&
             (!look_for_specific || requests->status == look_for_specific)
             && (look_for_specific || asp->index == 0
-                || requests->index < asp->index)) {
+                || requests->index <= asp->index)) {
             asp->index = requests->index;
             asp->status = requests->status;
         }
-- 
2.43.0

